{% extends "layout.html" %}
{% block content %}
<style>
    .prediction-form-container {
        display: none; /* Hidden by default until JS auth check */
    }
    .prediction-form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }
    #auth-message {
        text-align: center;
        font-size: 1.2rem;
        font-weight: 500;
    }
    .slider-group {
        margin-top: 1rem;
    }
    .slider-label {
        display: flex;
        justify-content: space-between;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 10px;
        border-radius: 5px;
        background: var(--light-grey);
        outline: none;
        opacity: 0.7;
        transition: opacity .2s;
    }
    .slider:hover {
        opacity: 1;
    }
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
    }
    .btn-submit {
        grid-column: 1 / -1; /* Span full width */
        margin-top: 1rem;
    }

    /* Responsive for single column on small screens */
    @media (max-width: 768px) {
        .prediction-form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="card prediction-form-container" id="prediction-content">
    <h1>Loan Eligibility Predictor</h1>
    <p>Fill in your details to predict your loan status with our AI model. All fields are required.</p>
    
    <form action="/predict" method="post" onsubmit="convertCreditValue()">
        <div class="prediction-form-grid">
            
            <div class="form-group">
                <label for="gender">Gender</label>
                <select name="gender" class="form-control" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>

            <div class="form-group">
                <label for="married">Married</label>
                <select name="married" class="form-control" required>
                    <option value="">Select Status</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>

            <div class="form-group">
                <label for="dependents">Dependents</label>
                <select name="dependents" class="form-control" required>
                    <option value="">Select Dependents</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3+">3+</option>
                </select>
            </div>

            <div class="form-group">
                <label for="education">Education</label>
                <select name="education" class="form-control" required>
                    <option value="">Select Education</option>
                    <option value="Graduate">Graduate</option>
                    <option value="Not Graduate">Not Graduate</option>
                </select>
            </div>

            <div class="form-group">
                <label for="employed">Self Employed</label>
                <select name="employed" class="form-control" required>
                    <option value="">Select Status</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>

            <div class="form-group">
                <label for="area">Property Area</label>
                <select name="area" class="form-control" required>
                    <option value="">Select Property Area</option>
                    <option value="Rural">Rural</option>
                    <option value="Semiurban">Semiurban</option>
                    <option value="Urban">Urban</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ApplicantIncome">Applicant Income (Monthly)</label>
                <input type="number" name="ApplicantIncome" class="form-control" placeholder="e.g., 5000" required min="0">
            </div>

            <div class="form-group">
                <label for="CoapplicantIncome">Co-applicant Income (Monthly)</label>
                <input type="number" name="CoapplicantIncome" class="form-control" placeholder="e.g., 2000" required min="0">
            </div>

            <div class="form-group">
                <label for="LoanAmount">Loan Amount (Total)</label>
                <input type="number" name="LoanAmount" class="form-control" placeholder="e.g., 150000" required min="1">
            </div>

            <div class="form-group">
                <label for="Loan_Amount_Term">Loan Term (in Days)</label>
                <input type="number" name="Loan_Amount_Term" class="form-control" placeholder="e.g., 360" required min="1">
            </div>

            <div class="form-group slider-group" style="grid-column: 1 / -1;">
                <div class="slider-label">
                    <span>Credit Score</span>
                    <span id="creditValue">500</span>
                </div>
                <input type="range" id="creditSlider" name="creditSlider" min="0" max="1000" value="500" class="slider" oninput="updateCreditValue(this.value)">
                <input type="hidden" id="credit" name="credit" value="0">
            </div>

            <button type="submit" class="btn btn-submit">Check Eligibility</button>
        </div>
    </form>
</div>

<div id="auth-message" class="card" style="display: none;">
    <h1>Access Denied</h1>
    <p>Please <a href="{{ url_for('login') }}">log in</a> to use the Prediction tool. You will be redirected.</p>
</div>

<script>
    function updateCreditValue(value) {
        document.getElementById("creditValue").textContent = value;
    }
    
    function convertCreditValue(){
        const creditScore = parseInt(document.getElementById('creditSlider').value);
        // LOGIC SYNC: Use >= 800 to match Streamlit
        const creditBinary = (creditScore >= 800 && creditScore <= 1000 ) ? 1 : 0;
        document.getElementById('credit').value = creditBinary;
    }

    // --- Client-side page lock ---
    const predictionContent = document.getElementById('prediction-content');
    const authMessage = document.getElementById('auth-message');
    
    document.addEventListener('DOMContentLoaded', () => {
         firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // User is logged in, show the form
                predictionContent.style.display = 'block';
                authMessage.style.display = 'none';
            } else {
                // User is not logged in, show auth message and redirect
                predictionContent.style.display = 'none';
                authMessage.style.display = 'block';
                setTimeout(() => {
                    window.location.href = "{{ url_for('login') }}";
                }, 2500);
            }
         });
    });
</script>
{% endblock %}